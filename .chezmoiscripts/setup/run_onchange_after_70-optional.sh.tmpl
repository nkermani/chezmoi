#!/bin/bash
{{ include ".chezmoitemplates/env.sh.tmpl" }}

# --- PERSONAL DATA (Notes) ---
echo "ðŸ““ Syncing knowledge base..."
NOTES_DIR="$NK_DIR/notes"
if [ ! -d "$NOTES_DIR/.git" ]; then
    git clone "git@github.com:nkermani/notes.git" "$NOTES_DIR" || echo "  âš ï¸  Notes clone failed. Check SSH keys."
fi

# --- OPTIONAL TOOLS (OpenCode AI, Bun, Yazi) ---

# 1. OPENCODE.AI
if [ ! -d "$APPS_DIR/opencode" ]; then
    echo "  ðŸ¤– Installing OpenCode.ai (Local installation)..."
    mkdir -p "$APPS_DIR/opencode"
    # Run the official installer within the apps directory to keep it portable
    (cd "$APPS_DIR" && curl -fsSL https://opencode.ai/install | bash)
    # Create symlinks in your personal bin directory
    ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/opencode"
    ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/code"
    echo "  âœ… OpenCode.ai installed"
fi

# 2. BUN (for oh-my-opencode)
if ! command -v bun &>/dev/null; then
    echo "  ðŸž Installing Bun..."
    export BUN_INSTALL="$APPS_DIR/bun"
    curl -fsSL https://bun.sh/install | bash
    ln -sf "$BUN_INSTALL/bin/bun" "$BIN_DIR/bun"
    ln -sf "$BUN_INSTALL/bin/bunx" "$BIN_DIR/bunx"
fi

# 3. OH-MY-OPENCODE (Plugin)
if command -v opencode &>/dev/null; then
    if ! opencode --version 2>&1 | grep -q "oh-my-opencode"; then
        echo "  âœ¨ Installing Oh My OpenCode..."
        if command -v bunx &>/dev/null; then
            bunx oh-my-opencode install --no-tui --claude=no --openai=no --gemini=no --copilot=yes
        elif command -v npx &>/dev/null; then
            npx oh-my-opencode install --no-tui --claude=no --openai=no --gemini=no --copilot=yes
        else
            echo "  âš ï¸  bunx/npx not found. Please install Bun or Node.js to install oh-my-opencode."
        fi
    else
        echo "  âœ… Oh My OpenCode is already installed."
    fi
fi

# 4. Yazi File Manager
echo "ðŸ“‚ Checking Yazi..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    if command -v brew &>/dev/null && ! command -v yazi &>/dev/null; then
        brew install yazi
    fi
else
    # Manual installation for Linux/42
    if [ ! -f "$BIN_DIR/yazi" ]; then
        echo "  ðŸ“¦ Installing Yazi..."
        YAZI_VER=$(curl -sI "https://github.com/sxyazi/yazi/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
        local YAZI_ARCH="x86_64"
        [[ "$ARCH_TYPE" == "aarch64" || "$ARCH_TYPE" == "arm64" ]] && YAZI_ARCH="aarch64"
        curl -L -o /tmp/yazi.zip "https://github.com/sxyazi/yazi/releases/download/${YAZI_VER}/yazi-${YAZI_ARCH}-unknown-linux-musl.zip"
        unzip -q -o /tmp/yazi.zip -d /tmp
        YAZI_DIR=$(find /tmp -maxdepth 1 -type d -name "yazi-*-linux-musl" | head -n 1)
        if [ -d "$YAZI_DIR" ]; then
            mv "$YAZI_DIR/yazi" "$BIN_DIR/"
            [ -f "$YAZI_DIR/ya" ] && mv "$YAZI_DIR/ya" "$BIN_DIR/"
            rm -rf "$YAZI_DIR" /tmp/yazi.zip
        fi
    fi
fi
