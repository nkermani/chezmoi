#!/bin/bash
{{ include ".chezmoitemplates/env.sh.tmpl" }}

echo "‚öôÔ∏è  Setting up runtimes..."
# Node via NVM
if [[ "$IS_42" == "true" ]]; then
    export NVM_DIR="/goinfre/$USER/.nvm"
else
    export NVM_DIR="$APPS_DIR/nvm"
fi
mkdir -p "$NVM_DIR"

if [ ! -d "$NVM_DIR/versions" ]; then
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | NVM_DIR="$NVM_DIR" bash
fi
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

if ! command -v node &>/dev/null; then
    nvm install 22 && nvm use 22 && nvm alias default 22
    ln -sf "$(which node)" "$BIN_DIR/node"
    ln -sf "$(which npm)" "$BIN_DIR/npm"
fi

# Rust
if [[ "$IS_42" == "true" ]]; then
    export RUSTUP_HOME="/goinfre/$USER/.rustup"
    export CARGO_HOME="/goinfre/$USER/.cargo"
    export PATH="$CARGO_HOME/bin:$PATH"
    mkdir -p "$RUSTUP_HOME" "$CARGO_HOME" "$RUSTUP_HOME/tmp" "$RUSTUP_HOME/dl"
    export RUSTUP_DL_DIR="$RUSTUP_HOME/dl"
    export TMPDIR="$RUSTUP_HOME/tmp"
fi

if ! command -v cargo &>/dev/null; then
    echo "  ü¶Ä Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
fi

# Ensure default toolchain is set and rust-src is installed for rust-analyzer
if [[ "$IS_42" == "true" ]]; then
    export RUSTUP_HOME="/goinfre/$USER/.rustup"
    export CARGO_HOME="/goinfre/$USER/.cargo"
    mkdir -p "$RUSTUP_HOME" "$CARGO_HOME" "$RUSTUP_HOME/tmp" "$RUSTUP_HOME/dl" 2>/dev/null
    export RUSTUP_DL_DIR="$RUSTUP_HOME/dl"
    export TMPDIR="$RUSTUP_HOME/tmp"
fi
echo "  ü¶Ä Checking toolchain..."
if command -v rustup &>/dev/null; then
    if ! rustup show active-toolchain &>/dev/null; then
        echo "  ü¶Ä Setting default toolchain..."
        rustup default stable 2>/dev/null || true
    fi
    echo "  ü¶Ä Adding rust-src component..."
    rustup component add rust-src 2>/dev/null || echo "  ‚ö†Ô∏è rust-src failed, continuing..."
fi
