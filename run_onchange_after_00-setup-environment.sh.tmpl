#!/bin/bash

# ==============================================================================
# CHEZMOI DEPLOYMENT SCRIPT - NKERMANI HYBRID CONFIG (2026)
# Targets: macOS (ARM/Intel), Linux (Native), and 42 School (Goinfre)
# ==============================================================================

# --- 0. DATA INITIALIZATION (Template Variables) ---
# .is_42 : {{ .is_42 }}
# .has_sudo : {{ .has_sudo }}

# --- 1. CORE ENVIRONMENT SETUP ---
echo "üåê Initializing base environment..."
NK_DIR="$HOME/.nkermani"
APPS_DIR="$NK_DIR/apps"
BIN_DIR="$NK_DIR/bin"
mkdir -p "$APPS_DIR" "$BIN_DIR"

# OS Detection
OS_TYPE=$(uname -s)
ARCH_TYPE=$(uname -m)
IS_WSL=$(grep -i "microsoft" /proc/version 2>/dev/null)

# --- 2. SHELL SETUP (Oh My Zsh & Plugins) ---
echo "üêö Configuring Zsh environment..."
ZSH_DIR="$APPS_DIR/ohmyzsh"
ZSH_CUSTOM="$ZSH_DIR/custom"

if [ ! -d "$ZSH_DIR" ]; then
    echo "  üöÄ Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
    mv ~/.oh-my-zsh "$ZSH_DIR" 2>/dev/null || true
fi

mkdir -p "$ZSH_CUSTOM/plugins"
plugin_list=(
    "zsh-syntax-highlighting|https://github.com/zsh-users/zsh-syntax-highlighting.git"
    "zsh-autosuggestions|https://github.com/zsh-users/zsh-autosuggestions"
    "auto-notify|https://github.com/MichaelAquilina/zsh-auto-notify.git"
    "you-should-use|https://github.com/MichaelAquilina/zsh-you-should-use.git"
    "zsh-history-substring-search|https://github.com/zsh-users/zsh-history-substring-search"
)

for item in "${plugin_list[@]}"; do
    name="${item%%|*}"
    url="${item#*|}"
    if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
        echo "  üì• Cloning plugin: $name..."
        git clone --depth 1 "$url" "$ZSH_CUSTOM/plugins/$name"
    fi
done

# --- 3. SYSTEM TOOLS (FZF, Ripgrep, FD, Bat) ---
echo "üõ†Ô∏è  Installing CLI utilities..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    # Homebrew handles architecture automatically on macOS
    if command -v brew &>/dev/null; then
        brew install fzf ripgrep fd bat
    fi
else
    # Manual installation for Linux/42 (Portable Binaries)
    [ ! -f "$BIN_DIR/fzf" ] && {
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --bin && cp ~/.fzf/bin/fzf "$BIN_DIR/" && rm -rf ~/.fzf
    }

    for tool in "ripgrep:rg:BurntSushi/ripgrep" "fd:fd:sharkdp/fd" "bat:bat:sharkdp/bat"; do
        IFS=":" read -r name bin repo <<< "$tool"
        if [ ! -f "$BIN_DIR/$bin" ]; then
            echo "  üì¶ Fetching $name..."
            VER=$(curl -sI "https://github.com/$repo/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
            curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${VER}-x86_64-unknown-linux-musl.tar.gz" | tar -xzC /tmp
            find /tmp/${name}-${VER}-x86_64-unknown-linux-musl -name "$bin" -type f -exec cp {} "$BIN_DIR/" \;
        fi
    done
fi

# --- 4. FONTS (Typography) ---
if [[ "$OS_TYPE" == "Linux" ]]; then
    echo "üî° Checking Fonts..."
    FONT_DIR="$HOME/.local/share/fonts"
    if [ ! -d "$FONT_DIR/JetBrainsMono" ] && ! fc-list | grep -qi "JetBrainsMono"; then
        mkdir -p "$FONT_DIR/JetBrainsMono"
        curl -L -o /tmp/jb.zip https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/JetBrainsMono.zip
        unzip -o /tmp/jb.zip -d "$FONT_DIR/JetBrainsMono" && rm /tmp/jb.zip
        fc-cache -f
    fi
fi

# --- 5. TERMINAL (Kitty) ---
echo "üê± Configuring Kitty Terminal..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    if ! command -v kitty &>/dev/null; then
        brew install --cask kitty
        ln -sf "/Applications/kitty.app/Contents/MacOS/kitty" "$BIN_DIR/kitty"
    fi
elif [[ "{{ .is_42 }}" == "true" && -z "$IS_WSL" ]]; then
    if [ ! -d "$APPS_DIR/kitty.app" ]; then
        curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin dest="$APPS_DIR"
        ln -sf "$APPS_DIR/kitty.app/bin/kitty" "$BIN_DIR/kitty"
    fi
fi

# --- 6. DEVELOPMENT RUNTIMES (Node/NVM & Rust) ---
echo "‚öôÔ∏è  Setting up runtimes..."
# Node via NVM
if [[ "{{ .is_42 }}" == "true" ]]; then
    export NVM_DIR="/goinfre/$USER/.nvm"
else
    export NVM_DIR="$APPS_DIR/nvm"
fi
mkdir -p "$NVM_DIR"

if [ ! -d "$NVM_DIR/versions" ]; then
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | NVM_DIR="$NVM_DIR" bash
fi
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

if ! command -v node &>/dev/null; then
    nvm install 22 && nvm use 22 && nvm alias default 22
    ln -sf "$(which node)" "$BIN_DIR/node"
    ln -sf "$(which npm)" "$BIN_DIR/npm"
fi

# Rust
if ! command -v cargo &>/dev/null; then
    echo "  ü¶Ä Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
fi

# --- 7. TEXT EDITORS (Neovim Nightly) ---
echo "üåô Configuring Neovim..."
if [ ! -f "$BIN_DIR/nvim" ]; then
    NVIM_INSTALL_DIR="$APPS_DIR/nvim-nightly"
    mkdir -p "$NVIM_INSTALL_DIR"
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        # Native Apple Silicon support
        curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-macos-arm64.tar.gz | tar -xzC "$NVIM_INSTALL_DIR" --strip-components=1
    else
        curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz | tar -xzC "$NVIM_INSTALL_DIR" --strip-components=1
    fi
    ln -sf "$NVIM_INSTALL_DIR/bin/nvim" "$BIN_DIR/nvim"
fi

# Plugin installation
INSTALL_PLUGINS_SCRIPT="$HOME/.config/nvim/scripts/install-nvim-plugins.sh"
if [ -f "$INSTALL_PLUGINS_SCRIPT" ]; then
    chmod +x "$INSTALL_PLUGINS_SCRIPT" && bash "$INSTALL_PLUGINS_SCRIPT"
fi

# --- 7.1 ADDITIONAL LSP SERVERS (Sudoless) ---
LSP_BIN_DIR="$HOME/.nkermani/bin/lsp"
mkdir -p "$LSP_BIN_DIR"

# Fonction utilitaire pour les LSP installables via NPM
install_npm_lsp() {
    local name=$1
    local package=$2
    local binary=$3
    if [ ! -f "$LSP_BIN_DIR/$binary" ]; then
        echo "  üì¶ Installing $name..."
        npm install -g "$package" --prefix "$APPS_DIR/$name" &>/dev/null
        ln -sf "$APPS_DIR/$name/bin/$binary" "$LSP_BIN_DIR/$binary"
    fi
}

echo "üõ†Ô∏è  Setting up additional LSP servers in $LSP_BIN_DIR..."

# 1. Lua (LuaLS)
if [ ! -f "$LSP_BIN_DIR/lua-language-server" ]; then
    echo "  üåô Installing LuaLS..."
    if [[ "$OS_TYPE" == "Darwin" ]] && command -v brew &>/dev/null; then
        brew install lua-language-server
        ln -sf "$(which lua-language-server)" "$LSP_BIN_DIR/lua-language-server"
    else
        LUA_LS_DIR="$APPS_DIR/lua-language-server"
        mkdir -p "$LUA_LS_DIR"
        LUA_VER=$(curl -sI "https://github.com/LuaLS/lua-language-server/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
        PLATFORM="linux-x64"
        [[ "$ARCH_TYPE" == "aarch64" ]] && PLATFORM="linux-arm64"

        curl -LSs "https://github.com/LuaLS/lua-language-server/releases/download/${LUA_VER}/lua-language-server-${LUA_VER}-${PLATFORM}.tar.gz" | tar -xzC "$LUA_LS_DIR"
        ln -sf "$LUA_LS_DIR/bin/lua-language-server" "$LSP_BIN_DIR/lua-language-server"
    fi
fi

# 2. Python (Pyright)
install_npm_lsp "pyright" "pyright" "pyright-langserver"

# 3. JavaScript / TypeScript
install_npm_lsp "typescript-lsp" "typescript typescript-language-server" "typescript-language-server"

# 4. Shell (Bash)
install_npm_lsp "bash-lsp" "bash-language-server" "bash-language-server"

# 5. Dotenv
install_npm_lsp "dotenv-lsp" "dot-language-server" "dot-language-server"

# 6. C / C++ (clangd)
if [ ! -f "$LSP_BIN_DIR/clangd" ]; then
    echo "  ‚öôÔ∏è  Installing clangd..."
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        brew install llvm && ln -sf "$(brew --prefix llvm)/bin/clangd" "$LSP_BIN_DIR/clangd"
    else
        CLANGD_DIR="$APPS_DIR/clangd"
        mkdir -p "$CLANGD_DIR"
        curl -L -s https://github.com/clangd/clangd/releases/download/17.0.3/clangd-linux-17.0.3.zip -o /tmp/clangd.zip
        unzip -q /tmp/clangd.zip -d "$CLANGD_DIR"
        ln -sf "$CLANGD_DIR/clangd_17.0.3/bin/clangd" "$LSP_BIN_DIR/clangd"
        rm /tmp/clangd.zip
    fi
fi

# 7. C# (OmniSharp)
if [ ! -f "$LSP_BIN_DIR/omnisharp" ]; then
    echo "  üéØ Installing OmniSharp..."
    OMNISHARP_DIR="$APPS_DIR/omnisharp"
    mkdir -p "$OMNISHARP_DIR"
    OS_SUFFIX="linux-x64"
    [[ "$OS_TYPE" == "Darwin" ]] && OS_SUFFIX="osx-arm64-net6.0"

    curl -L -s "https://github.com/OmniSharp/omnisharp-roslyn/releases/latest/download/omnisharp-${OS_SUFFIX}.tar.gz" | tar -xzC "$OMNISHARP_DIR"
    ln -sf "$OMNISHARP_DIR/OmniSharp" "$LSP_BIN_DIR/omnisharp"
fi
# --- 8. PERSONAL DATA (Notes) ---
echo "üìì Syncing knowledge base..."
NOTES_DIR="$NK_DIR/notes"
if [ ! -d "$NOTES_DIR/.git" ]; then
    git clone "git@github.com:nkermani/notes.git" "$NOTES_DIR" || echo "  ‚ö†Ô∏è  Notes clone failed. Check SSH keys."
fi

# --- 9. OPTIONAL TOOLS (Zed & OpenCode AI) ---
# echo "‚ö° Checking optional editors and AI tools..."

# # 9.1 ZED EDITOR
# if ! command -v zed &>/dev/null && ! command -v zed-editor &>/dev/null; then
#     echo "  üì¶ Installing Zed Editor..."
#     if [[ "$OS_TYPE" == "Darwin" ]]; then
#         # macOS: Install via Homebrew Cask
#         brew install --cask zed
#         ln -sf "/Applications/Zed.app/Contents/MacOS/zed" "$BIN_DIR/zed"
#     elif [[ -n "$IS_WSL" ]]; then
#         echo "  üí° Note: On WSL2, install Zed on Windows for the best experience."
#     else
#         # Linux: Portable installation (Native or 42 without sudo)
#         ZED_INSTALL_DIR="$APPS_DIR/zed-editor"
#         mkdir -p "$ZED_INSTALL_DIR"
#         curl -fL https://zed.dev/install.sh | ZED_RELEASE_CHANNEL=stable PREFIX="$ZED_INSTALL_DIR" sh
#         ln -sf "$ZED_INSTALL_DIR/bin/zed" "$BIN_DIR/zed"
#     fi
# fi

 # 9.2 OPENCODE.AI
 if [ ! -d "$APPS_DIR/opencode" ]; then
     echo "  ü§ñ Installing OpenCode.ai (Local installation)..."
     mkdir -p "$APPS_DIR/opencode"
     # Run the official installer within the apps directory to keep it portable
     (cd "$APPS_DIR" && curl -fsSL https://opencode.ai/install | bash)
     # Create symlinks in your personal bin directory
     # 'code' is linked to opencode here to use it as your primary AI-powered editor
     ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/opencode"
     ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/code"
     echo "  ‚úÖ OpenCode.ai installed"
 fi

# 9.3 Yazi File Manager
echo "üìÇ Checking Yazi..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    if command -v brew &>/dev/null && ! command -v yazi &>/dev/null; then
        brew install yazi
    fi
else
    # Manual installation for Linux/42
    if [ ! -f "$BIN_DIR/yazi" ]; then
        echo "  üì¶ Installing Yazi..."
        YAZI_VER=$(curl -sI "https://github.com/sxyazi/yazi/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
        curl -L -o /tmp/yazi.zip "https://github.com/sxyazi/yazi/releases/download/${YAZI_VER}/yazi-x86_64-unknown-linux-musl.zip"
        unzip -q -o /tmp/yazi.zip -d /tmp
        YAZI_DIR=$(find /tmp -maxdepth 1 -type d -name "yazi-*-linux-musl" | head -n 1)
        if [ -d "$YAZI_DIR" ]; then
            mv "$YAZI_DIR/yazi" "$BIN_DIR/"
            [ -f "$YAZI_DIR/ya" ] && mv "$YAZI_DIR/ya" "$BIN_DIR/"
            rm -rf "$YAZI_DIR" /tmp/yazi.zip
        fi
    fi
fi

# --- 10. FINALIZATION ---
if [[ "$SHELL" != */zsh ]]; then
    echo "üêö Setting default shell to Zsh..."
    chsh -s $(which zsh)
fi

echo "-------------------------------------------------------"
echo "‚úÖ Deployment Successful!"
echo "‚ú® Restart your terminal or run 'source ~/.zshrc'"
echo "-------------------------------------------------------"

# End of Script

