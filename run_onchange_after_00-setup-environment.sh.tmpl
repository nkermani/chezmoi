#!/bin/bash

# --- CONFIGURATION CHEZMOI ---
# .is_42 : {{ .is_42 }}
# .has_sudo : {{ .has_sudo }}

# 1. Dossiers de base
NK_DIR="$HOME/.nkermani"
APPS_DIR="$NK_DIR/apps"
BIN_DIR="$NK_DIR/bin"
mkdir -p "$APPS_DIR" "$BIN_DIR"

# D√©tection imm√©diate de l'OS et environnement (Important pour la suite)
OS_TYPE=$(uname -s)
IS_WSL=$(grep -i "microsoft" /proc/version 2>/dev/null)

# 2. Oh My Zsh & Plugins (Tous tes plugins sont ici)
ZSH_DIR="$APPS_DIR/ohmyzsh"
if [ ! -d "$ZSH_DIR" ]; then
    echo "üöÄ Installation de Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
    mv ~/.oh-my-zsh "$ZSH_DIR" 2>/dev/null || true
fi

ZSH_CUSTOM="$ZSH_DIR/custom"
declare -A plugins=(
    ["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting.git"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
    ["auto-notify"]="https://github.com/MichaelAquilina/zsh-auto-notify.git"
    ["you-should-use"]="https://github.com/MichaelAquilina/zsh-you-should-use.git"
    ["zsh-history-substring-search"]="https://github.com/zsh-users/zsh-history-substring-search"
    )

for name in "${!plugins[@]}"; do
if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
echo "üîå Installation du plugin $name..."
git clone "${plugins[$name]}" "$ZSH_CUSTOM/plugins/$name"
fi
done

# --- 3. OUTILS CLI (Installation forc√©e dans NK_BIN) ---
echo "üõ†Ô∏è Installation des outils CLI dans $BIN_DIR..."

if [[ "$OS_TYPE" == "Darwin" ]]; then
    command -v brew &>/dev/null && brew install fzf ripgrep fd bat
else
    # FZF : On force l'installation si le binaire n'est pas dans NOTRE dossier bin
    if [ ! -f "$BIN_DIR/fzf" ]; then
        echo "üì¶ Installation de FZF..."
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
        ~/.fzf/install --bin
        cp ~/.fzf/bin/fzf "$BIN_DIR/"
        rm -rf ~/.fzf
    fi

    # Ripgrep, FD, Bat : On v√©rifie la pr√©sence du fichier dans BIN_DIR
    for tool in "ripgrep:rg:BurntSushi/ripgrep" "fd:fd:sharkdp/fd" "bat:bat:sharkdp/bat"; do
        IFS=":" read -r name bin repo <<< "$tool"

        if [ ! -f "$BIN_DIR/$bin" ]; then
            echo "üì¶ Installation de $name dans $BIN_DIR..."
            VER=$(curl -sI "https://github.com/$repo/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')

            # T√©l√©chargement et extraction
            curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${VER}-x86_64-unknown-linux-musl.tar.gz" | tar -xzC /tmp

            # On trouve le binaire dans l'archive extraite et on le place dans BIN_DIR
            find /tmp/${name}-${VER}-x86_64-unknown-linux-musl -name "$bin" -type f -exec cp {} "$BIN_DIR/" \;
        fi
    done
fi

# --- 4. POLICES (JetBrains Mono Nerd Font) ---
if [[ "$OS_TYPE" == "Linux" ]]; then
FONT_DIR="$HOME/.local/share/fonts"
# On v√©rifie si le dossier existe d√©j√† OU si la font est d√©j√† install√©e dans le syst√®me
if [ ! -d "$FONT_DIR/JetBrainsMono" ] && ! fc-list | grep -qi "JetBrainsMono"; then
echo "üíæ JetBrainsMono Nerd Font non trouv√©e. Installation..."
mkdir -p "$FONT_DIR/JetBrainsMono"

# T√©l√©chargement dans /tmp pour √©conomiser le quota disque
curl -L -o /tmp/jb.zip https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/JetBrainsMono.zip

# -o pour overwrite sans demander, -d pour la destination
unzip -o /tmp/jb.zip -d "$FONT_DIR/JetBrainsMono"

# Nettoyage imm√©diat du zip
rm /tmp/jb.zip

# Mise √† jour du cache des polices (le -f force la relecture)
echo "Updating font cache..."
fc-cache -f
echo "‚úÖ Police install√©e avec succ√®s."
else
echo "‚úÖ JetBrainsMono Nerd Font est d√©j√† pr√©sente."
fi
fi

# 5. LOGIQUE SPECIFIQUE (42 vs PERSO)
{{ if .is_42 -}}
echo "üè´ Mode 42 activ√©..."
if [[ "$OS_TYPE" == "Linux" && -z "$IS_WSL" ]]; then
# VS Code
if [ ! -d "$APPS_DIR/vscode" ]; then
echo "üì¶ Installation VS Code..."
curl -L "https://code.visualstudio.com/sha/download?build=stable&os=linux-x64" | tar -xzC "$APPS_DIR"
mv "$APPS_DIR/VSCode-linux-x64" "$APPS_DIR/vscode" 2>/dev/null
ln -sf "$APPS_DIR/vscode/bin/code" "$BIN_DIR/code"
fi
# Kitty + Ic√¥nes Desktop
if [ ! -d "$APPS_DIR/kitty.app" ]; then
echo "üê± Installation Kitty..."
curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin dest="$APPS_DIR"
ln -sf "$APPS_DIR/kitty.app/bin/kitty" "$BIN_DIR/kitty"
mkdir -p ~/.local/share/applications
cp "$APPS_DIR/kitty.app/share/applications/kitty.desktop" ~/.local/share/applications/
sed -i "s|Icon=kitty|Icon=$APPS_DIR/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" ~/.local/share/applications/kitty.desktop
sed -i "s|Exec=kitty|Exec=$APPS_DIR/kitty.app/bin/kitty|g" ~/.local/share/applications/kitty.desktop
fi
fi
{{- end }}

# --- 5.5 NODE.JS via NVM (Optimis√© 42 Goinfre) ---
if [[ "$is_42" == "true" ]]; then
    # D√©finition du chemin dans le goinfre sp√©cifique √† l'utilisateur
    GOINFRE_USER="/goinfre/$USER"
    mkdir -p "$GOINFRE_USER"
    export NVM_DIR="$GOINFRE_USER/.nvm"
else
    export NVM_DIR="$APPS_DIR/nvm"
fi

if [ ! -d "$NVM_DIR" ]; then
    echo "üì¶ Installation de NVM dans $NVM_DIR..."
    mkdir -p "$NVM_DIR"
    # Installation forc√©e dans le dossier choisi
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | NVM_DIR="$NVM_DIR" bash
fi

# Charger NVM imm√©diatement
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Installation de Node 22
if ! command -v node &>/dev/null || [[ $(node -v | cut -d'v' -f2 | cut -d'.' -f1) -lt 22 ]]; then
    echo "üü¢ Installation de Node.js 22..."
    nvm install 22
    nvm use 22
    nvm alias default 22

    # Liens symboliques dans ton BIN_DIR personnel pour que 'node' soit dans le PATH
    ln -sf "$(which node)" "$BIN_DIR/node"
    ln -sf "$(which npm)" "$BIN_DIR/npm"
fi

# --- 6. NEOVIM NIGHTLY (Sudoless & Portable) ---
if [ ! -f "$BIN_DIR/nvim" ]; then
    echo "üåô Installation Neovim Nightly dans $APPS_DIR..."
    NVIM_INSTALL_DIR="$APPS_DIR/nvim-nightly"
    mkdir -p "$NVIM_INSTALL_DIR"

    # T√©l√©chargement de l'archive Linux x86_64
    curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz | tar -xzC "$NVIM_INSTALL_DIR" --strip-components=1

    # Cr√©ation du lien symbolique vers ton dossier bin personnel
    ln -sf "$NVIM_INSTALL_DIR/bin/nvim" "$BIN_DIR/nvim"
    echo "‚úÖ Neovim Nightly install√© avec succ√®s."
fi

# --- 7. RUST / CARGO ---
if ! command -v cargo &>/dev/null; then
    echo "ü¶Ä Installation de Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
    # Source cargo pour l'utiliser imm√©diatement
    source "$HOME/.cargo/env"
fi

# --- 8. ZED EDITOR ---
echo "‚ö° Installation de Zed Editor..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    # macOS
    command -v brew &>/dev/null && brew install --cask zed
elif [[ -n "$IS_WSL" ]]; then
    # Sur WSL2, Zed tourne mieux c√¥t√© Windows (UI).
    # On affiche un message car l'installateur Linux n'a pas de serveur X/Wayland par d√©faut.
    echo "üí° Note: Sur WSL2, installez Zed sur Windows pour une meilleure exp√©rience."
else
    # LINUX (Natif ou 42 sans sudo)
    if ! command -v zed &>/dev/null; then
        echo "üì¶ T√©l√©chargement de Zed (Linux portable)..."
        ZED_INSTALL_DIR="$APPS_DIR/zed-editor"
        mkdir -p "$ZED_INSTALL_DIR"

        # R√©cup√©ration de la derni√®re version stable
        curl -fL https://zed.dev/install.sh | ZED_RELEASE_CHANNEL=stable PREFIX="$ZED_INSTALL_DIR" sh

        # Link vers ton BIN_DIR personnel
        ln -sf "$ZED_INSTALL_DIR/bin/zed" "$BIN_DIR/zed"
    fi
fi

# --- 9. NOTES (Isol√©es dans leur propre sous-dossier) ---
NOTES_DIR="$NK_DIR/notes"
NOTES_REPO="git@github.com:nkermani/notes.git"

if [ ! -d "$NOTES_DIR/.git" ]; then
    echo "üìì Installation de la biblioth√®que de notes dans $NOTES_DIR..."
    mkdir -p "$NK_DIR"
    # On clone dans 'notes' pour ne pas interf√©rer avec 'bin' et 'apps'
    git clone "$NOTES_REPO" "$NOTES_DIR" || echo "‚ö†Ô∏è Attention: Le clone des notes a √©chou√© (v√©rifiez SSH/Repo vide)."
fi

# 10. ---  Shell par d√©faut ---
if [[ "$SHELL" != */zsh ]]; then
    echo "üêö Changement du shell vers ZSH..."
chsh -s $(which zsh)
    fi

# --- 11. D√âCLENCHEMENT DE L'INSTALLATION DES PLUGINS ---
# On utilise le script que tu as d√©j√† dans ton dossier de config
INSTALL_PLUGINS_SCRIPT="$HOME/.config/nvim/scripts/install-nvim-plugins.sh"

if [ -f "$INSTALL_PLUGINS_SCRIPT" ]; then
    echo "üì¶ Ex√©cution du script d'installation des plugins Neovim..."
    # On s'assure qu'il est ex√©cutable
    chmod +x "$INSTALL_PLUGINS_SCRIPT"
    # On l'ex√©cute
    bash "$INSTALL_PLUGINS_SCRIPT"
else
    echo "‚ö†Ô∏è Script de plugins non trouv√© √† l'emplacement : $INSTALL_PLUGINS_SCRIPT"
    echo "Avez-vous bien clon√© vos dotfiles avant ?"
fi

# --- 12. OPENCODE.AI (Installation via script officiel) ---
if [ ! -d "$APPS_DIR/opencode" ]; then
    echo "ü§ñ Installation de OpenCode.ai via le script officiel..."

    # On d√©finit le PREFIX pour forcer l'installation dans ton dossier perso
    # Le script opencode respecte g√©n√©ralement la variable PREFIX ou s'installe dans le dossier courant
    mkdir -p "$APPS_DIR/opencode"

    # On se d√©place dans apps pour que l'installation reste locale
    (cd "$APPS_DIR" && curl -fsSL https://opencode.ai/install | bash)

    # On cr√©e le lien symbolique vers ton BIN_DIR personnel
    # (V√©rifie le nom exact du binaire apr√®s l'install, souvent 'opencode')
    ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/opencode"
    ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/code"

    echo "‚úÖ OpenCode.ai est pr√™t."
fi

echo "‚ú® Configuration termin√©e avec succ√®s !"
echo "‚ú® Termin√© ! Relance ton terminal ou 'source ~/.zshrc'."

