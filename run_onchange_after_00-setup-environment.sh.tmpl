#!/bin/bash

# ==============================================================================
# CHEZMOI DEPLOYMENT SCRIPT - NKERMANI HYBRID CONFIG (2026)
# Targets: macOS (ARM/Intel), Linux (Native), and 42 School (Goinfre)
# ==============================================================================

# --- 0. DATA INITIALIZATION (Template Variables) ---
# .is_42 : {{ .is_42 }}
# .has_sudo : {{ .has_sudo }}

# --- 1. CORE ENVIRONMENT SETUP ---
echo "ðŸŒ Initializing base environment..."
NK_DIR="$HOME/.nkermani"
APPS_DIR="$NK_DIR/apps"
BIN_DIR="$NK_DIR/bin"
mkdir -p "$APPS_DIR" "$BIN_DIR"

# OS Detection
OS_TYPE=$(uname -s)
ARCH_TYPE=$(uname -m)
IS_WSL=""
if [[ "$OS_TYPE" == "Linux" ]]; then
    if [[ -f /proc/sys/kernel/osrelease ]] && grep -qi "microsoft" /proc/sys/kernel/osrelease; then
        IS_WSL="true"
    elif grep -qi "microsoft" /proc/version 2>/dev/null; then
        IS_WSL="true"
    fi
fi

# --- 2. SHELL SETUP (Oh My Zsh & Plugins) ---
echo "ðŸš Configuring Zsh environment..."
ZSH_DIR="$APPS_DIR/ohmyzsh"
ZSH_CUSTOM="$ZSH_DIR/custom"

if [ ! -d "$ZSH_DIR" ]; then
    echo "  ðŸš€ Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
    mv ~/.oh-my-zsh "$ZSH_DIR" 2>/dev/null || true
fi

mkdir -p "$ZSH_CUSTOM/plugins"
plugin_list=(
    "zsh-syntax-highlighting|https://github.com/zsh-users/zsh-syntax-highlighting.git"
    "zsh-autosuggestions|https://github.com/zsh-users/zsh-autosuggestions"
    "auto-notify|https://github.com/MichaelAquilina/zsh-auto-notify.git"
    "you-should-use|https://github.com/MichaelAquilina/zsh-you-should-use.git"
    "zsh-history-substring-search|https://github.com/zsh-users/zsh-history-substring-search"
)

for item in "${plugin_list[@]}"; do
    name="${item%%|*}"
    url="${item#*|}"
    if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
        echo "  ðŸ“¥ Cloning plugin: $name..."
        git clone --depth 1 "$url" "$ZSH_CUSTOM/plugins/$name"
    fi
done

# --- 3. SYSTEM TOOLS (FZF, Ripgrep, FD, Bat, CMake, Tmux, Zellij) ---
echo "ðŸ› ï¸  Installing CLI utilities..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    # Homebrew handles architecture automatically on macOS
    if command -v brew &>/dev/null; then
        brew install fzf ripgrep fd bat cmake tmux zellij
    fi
else
    # Manual installation for Linux/42 (Portable Binaries)
    [ ! -f "$BIN_DIR/fzf" ] && {
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --bin && cp ~/.fzf/bin/fzf "$BIN_DIR/" && rm -rf ~/.fzf
    }

    # Architecture detection for Linux binaries
    LINUX_ARCH="x86_64"
    [[ "$ARCH_TYPE" == "aarch64" ]] && LINUX_ARCH="aarch64"

    for tool in "ripgrep:rg:BurntSushi/ripgrep" "fd:fd:sharkdp/fd" "bat:bat:sharkdp/bat"; do
        IFS=":" read -r name bin repo <<< "$tool"
        if [ ! -f "$BIN_DIR/$bin" ]; then
            echo "  ðŸ“¦ Fetching $name..."
            VER=$(curl -sI "https://github.com/$repo/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
            curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${VER}-${LINUX_ARCH}-unknown-linux-musl.tar.gz" | tar -xzC /tmp
            find /tmp/${name}-${VER}-${LINUX_ARCH}-unknown-linux-musl -name "$bin" -type f -exec cp {} "$BIN_DIR/" \;
        fi
    done

    # CMake installation for Linux/42 (Portable Binary)
    if [ ! -f "$BIN_DIR/cmake" ]; then
        echo "  ðŸ“¦ Fetching CMake..."
        CMAKE_VER="3.31.5"
        curl -LSs "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VER}/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}.tar.gz" | tar -xzC "$APPS_DIR"
        ln -sf "$APPS_DIR/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}/bin/cmake" "$BIN_DIR/cmake"
        ln -sf "$APPS_DIR/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}/bin/ctest" "$BIN_DIR/ctest"
    fi

    # Tmux installation for Linux/42 (Static Binary)
    if [ ! -f "$BIN_DIR/tmux" ]; then
        echo "  ðŸ“¦ Fetching Tmux (Static)..."
        TMUX_STATIC_URL="https://github.com/nicolas-van/tmux-main/releases/download/3.5a/tmux-linux-x86_64"
        [[ "$ARCH_TYPE" == "aarch64" ]] && TMUX_STATIC_URL="https://github.com/nicolas-van/tmux-main/releases/download/3.5a/tmux-linux-arm64"
        curl -LSs "$TMUX_STATIC_URL" -o "$BIN_DIR/tmux"
        chmod +x "$BIN_DIR/tmux"
    fi

    # Zellij installation for Linux/42 (Portable Binary)
    if [ ! -f "$BIN_DIR/zellij" ]; then
        echo "  ðŸ“¦ Fetching Zellij..."
        ZELLIJ_ARCH="x86_64"
        [[ "$ARCH_TYPE" == "aarch64" ]] && ZELLIJ_ARCH="aarch64"
        curl -LSs "https://github.com/zellij-org/zellij/releases/latest/download/zellij-${ZELLIJ_ARCH}-unknown-linux-musl.tar.gz" | tar -xzC "$BIN_DIR"
    fi
fi

# --- 3.1 SSHFS (REMOVED due to macOS restrictions) ---
# Note: sshfs on macOS requires macfuse (kext) or fuse-t (tap), both causing issues in automation.
# Recommend using `nvim scp://user@host//path/to/file` instead.

# --- 4. FONTS (Typography) ---
if [[ "$OS_TYPE" == "Linux" ]]; then
    echo "ðŸ”¡ Checking Fonts..."
    FONT_DIR="$HOME/.local/share/fonts"
    if [ ! -d "$FONT_DIR/JetBrainsMono" ] && ! fc-list | grep -qi "JetBrainsMono"; then
        mkdir -p "$FONT_DIR/JetBrainsMono"
        curl -L -o /tmp/jb.zip https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/JetBrainsMono.zip
        unzip -o /tmp/jb.zip -d "$FONT_DIR/JetBrainsMono" && rm /tmp/jb.zip
        fc-cache -f
    fi
fi

# --- 5. TERMINAL (Kitty) ---
echo "ðŸ± Configuring Kitty Terminal..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    if ! command -v kitty &>/dev/null; then
        brew install --cask kitty
        ln -sf "/Applications/kitty.app/Contents/MacOS/kitty" "$BIN_DIR/kitty"
    fi
elif [[ "{{ .is_42 }}" == "true" && -z "$IS_WSL" ]]; then
    if [ ! -d "$APPS_DIR/kitty.app" ]; then
        curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin dest="$APPS_DIR"
        ln -sf "$APPS_DIR/kitty.app/bin/kitty" "$BIN_DIR/kitty"
    fi
fi

# --- 6. DEVELOPMENT RUNTIMES (Node/NVM & Rust) ---
echo "âš™ï¸  Setting up runtimes..."
# Node via NVM
if [[ "{{ .is_42 }}" == "true" ]]; then
    export NVM_DIR="/goinfre/$USER/.nvm"
else
    export NVM_DIR="$APPS_DIR/nvm"
fi
mkdir -p "$NVM_DIR"

if [ ! -d "$NVM_DIR/versions" ]; then
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | NVM_DIR="$NVM_DIR" bash
fi
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

if ! command -v node &>/dev/null; then
    nvm install 22 && nvm use 22 && nvm alias default 22
    ln -sf "$(which node)" "$BIN_DIR/node"
    ln -sf "$(which npm)" "$BIN_DIR/npm"
fi

# Rust
if ! command -v cargo &>/dev/null; then
    echo "  ðŸ¦€ Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
fi

# Ensure rust-analyzer component is installed via rustup
if command -v rustup &>/dev/null; then
    rustup component add rust-analyzer
fi

# --- 7. TEXT EDITORS (Neovim Nightly) ---
echo "ðŸŒ™ Configuring Neovim..."
if [ ! -f "$BIN_DIR/nvim" ]; then
    NVIM_INSTALL_DIR="$APPS_DIR/nvim-nightly"
    mkdir -p "$NVIM_INSTALL_DIR"
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        # Native Apple Silicon support
        local MACOS_ARCH="x86_64"
        [[ "$(uname -m)" == "arm64" ]] && MACOS_ARCH="arm64"
        curl -LSs "https://github.com/neovim/neovim/releases/download/nightly/nvim-macos-${MACOS_ARCH}.tar.gz" | tar -xzC "$NVIM_INSTALL_DIR" --strip-components=1
    else
        curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz | tar -xzC "$NVIM_INSTALL_DIR" --strip-components=1
    fi
    ln -sf "$NVIM_INSTALL_DIR/bin/nvim" "$BIN_DIR/nvim"
fi

# Plugin installation
INSTALL_PLUGINS_SCRIPT="$HOME/.config/nvim/scripts/install-nvim-plugins.sh"
if [ -f "$INSTALL_PLUGINS_SCRIPT" ]; then
    chmod +x "$INSTALL_PLUGINS_SCRIPT" && bash "$INSTALL_PLUGINS_SCRIPT"
fi

# --- 7.1 ADDITIONAL LSP SERVERS (Sudoless) ---
LSP_BIN_DIR="$HOME/.nkermani/bin/lsp"
mkdir -p "$LSP_BIN_DIR"

# Fonction utilitaire pour les LSP installables via NPM
install_npm_lsp() {
    local name=$1
    local package=$2
    local binary=$3
    if [ ! -f "$LSP_BIN_DIR/$binary" ]; then
        echo "  ðŸ“¦ Installing $name..."
        npm install -g "$package" --prefix "$APPS_DIR/$name" &>/dev/null
        ln -sf "$APPS_DIR/$name/bin/$binary" "$LSP_BIN_DIR/$binary"
    fi
}

echo "ðŸ› ï¸  Setting up additional LSP servers in $LSP_BIN_DIR..."

# 1. Lua (LuaLS)
if [ ! -f "$LSP_BIN_DIR/lua-language-server" ]; then
    echo "  ðŸŒ™ Installing LuaLS..."
    if [[ "$OS_TYPE" == "Darwin" ]] && command -v brew &>/dev/null; then
        brew install lua-language-server
        ln -sf "$(which lua-language-server)" "$LSP_BIN_DIR/lua-language-server"
    else
        LUA_LS_DIR="$APPS_DIR/lua-language-server"
        mkdir -p "$LUA_LS_DIR"
        LUA_VER=$(curl -sI "https://github.com/LuaLS/lua-language-server/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
        PLATFORM="linux-x64"
        [[ "$ARCH_TYPE" == "aarch64" ]] && PLATFORM="linux-arm64"

        curl -LSs "https://github.com/LuaLS/lua-language-server/releases/download/${LUA_VER}/lua-language-server-${LUA_VER}-${PLATFORM}.tar.gz" | tar -xzC "$LUA_LS_DIR"
        ln -sf "$LUA_LS_DIR/bin/lua-language-server" "$LSP_BIN_DIR/lua-language-server"
    fi
fi

# 2. Python (Pyright + Formatters + pylsp)
install_npm_lsp "pyright" "pyright" "pyright-langserver"

if [[ "$OS_TYPE" == "Darwin" ]] && command -v brew &>/dev/null; then
    command -v pipx &>/dev/null || brew install pipx
    pipx ensurepath &>/dev/null
    command -v black &>/dev/null || pipx install black
    command -v isort &>/dev/null || pipx install isort
    if ! command -v pylsp &>/dev/null; then
        pipx install 'python-lsp-server[rope]'
    fi
    pipx inject python-lsp-server pyflakes pycodestyle 2>/dev/null || true
else
    if ! command -v black &>/dev/null || ! command -v isort &>/dev/null; then
        echo "  ðŸ Installing Python formatters (black, isort)..."
        if command -v pip3 &>/dev/null; then
            pip3 install --user black isort
        elif command -v pip &>/dev/null; then
            pip install --user black isort
        else
            echo "  âš ï¸  pip not found, skipping Python formatters."
        fi
    fi
    if ! command -v pylsp &>/dev/null; then
        echo "  ðŸ Installing pylsp with rope support..."
        if command -v pip3 &>/dev/null; then
            pip3 install --user 'python-lsp-server[rope]' pyflakes pycodestyle
        elif command -v pip &>/dev/null; then
            pip install --user 'python-lsp-server[rope]' pyflakes pycodestyle
        else
            echo "  âš ï¸  pip not found, skipping pylsp."
        fi
    else
        if command -v pip3 &>/dev/null; then
            pip3 install --user pyflakes pycodestyle 2>/dev/null || true
        elif command -v pip &>/dev/null; then
            pip install --user pyflakes pycodestyle 2>/dev/null || true
        fi
    fi
fi

# 3. JavaScript / TypeScript
install_npm_lsp "typescript-lsp" "typescript typescript-language-server" "typescript-language-server"

# 4. Shell (Bash)
install_npm_lsp "bash-lsp" "bash-language-server" "bash-language-server"

# 5. Dotenv
install_npm_lsp "dotenv-lsp" "dot-language-server" "dot-language-server"

# 6. C / C++ (clangd)
if [ ! -f "$LSP_BIN_DIR/clangd" ]; then
    echo "  âš™ï¸  Installing clangd..."
    if [[ "$OS_TYPE" == "Darwin" ]]; then
        brew install llvm && ln -sf "$(brew --prefix llvm)/bin/clangd" "$LSP_BIN_DIR/clangd"
    else
        CLANGD_DIR="$APPS_DIR/clangd"
        mkdir -p "$CLANGD_DIR"
        curl -L -s https://github.com/clangd/clangd/releases/download/17.0.3/clangd-linux-17.0.3.zip -o /tmp/clangd.zip
        unzip -q /tmp/clangd.zip -d "$CLANGD_DIR"
        ln -sf "$CLANGD_DIR/clangd_17.0.3/bin/clangd" "$LSP_BIN_DIR/clangd"
        rm /tmp/clangd.zip
    fi
fi

# 7. C# (OmniSharp)
if [ ! -f "$LSP_BIN_DIR/omnisharp" ]; then
    echo "  ðŸŽ¯ Installing OmniSharp..."
    OMNISHARP_DIR="$APPS_DIR/omnisharp"
    mkdir -p "$OMNISHARP_DIR"
    OS_SUFFIX="linux-x64"
    [[ "$OS_TYPE" == "Darwin" ]] && OS_SUFFIX="osx-arm64-net6.0"

    curl -L -s "https://github.com/OmniSharp/omnisharp-roslyn/releases/latest/download/omnisharp-${OS_SUFFIX}.tar.gz" | tar -xzC "$OMNISHARP_DIR"
    ln -sf "$OMNISHARP_DIR/OmniSharp" "$LSP_BIN_DIR/omnisharp"
fi

# 8. Rust (rust-analyzer)
if [ ! -f "$LSP_BIN_DIR/rust-analyzer" ]; then
    echo "  ðŸ¦€ Installing rust-analyzer..."
    if [[ "$OS_TYPE" == "Darwin" ]] && command -v brew &>/dev/null; then
        brew install rust-analyzer
        ln -sf "$(which rust-analyzer)" "$LSP_BIN_DIR/rust-analyzer"
    else
        RA_ARCH="x86_64"
        [[ "$ARCH_TYPE" == "aarch64" || "$ARCH_TYPE" == "arm64" ]] && RA_ARCH="aarch64"
        
        RA_OS="unknown-linux-gnu"
        [[ "$OS_TYPE" == "Darwin" ]] && RA_OS="apple-darwin"
        
        curl -L "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-${RA_ARCH}-${RA_OS}.gz" | gunzip > "$LSP_BIN_DIR/rust-analyzer"
        chmod +x "$LSP_BIN_DIR/rust-analyzer"
    fi
    # Ensure it's also in the main bin directory for convenience
    ln -sf "$LSP_BIN_DIR/rust-analyzer" "$BIN_DIR/rust-analyzer"
fi

# --- 8. PERSONAL DATA (Notes) ---
echo "ðŸ““ Syncing knowledge base..."
NOTES_DIR="$NK_DIR/notes"
if [ ! -d "$NOTES_DIR/.git" ]; then
    git clone "git@github.com:nkermani/notes.git" "$NOTES_DIR" || echo "  âš ï¸  Notes clone failed. Check SSH keys."
fi

# --- 9. OPTIONAL TOOLS (Zed & OpenCode AI) ---
# echo "âš¡ Checking optional editors and AI tools..."

# # 9.1 ZED EDITOR
# if ! command -v zed &>/dev/null && ! command -v zed-editor &>/dev/null; then
#     echo "  ðŸ“¦ Installing Zed Editor..."
#     if [[ "$OS_TYPE" == "Darwin" ]]; then
#         # macOS: Install via Homebrew Cask
#         brew install --cask zed
#         ln -sf "/Applications/Zed.app/Contents/MacOS/zed" "$BIN_DIR/zed"
#     elif [[ -n "$IS_WSL" ]]; then
#         echo "  ðŸ’¡ Note: On WSL2, install Zed on Windows for the best experience."
#     else
#         # Linux: Portable installation (Native or 42 without sudo)
#         ZED_INSTALL_DIR="$APPS_DIR/zed-editor"
#         mkdir -p "$ZED_INSTALL_DIR"
#         curl -fL https://zed.dev/install.sh | ZED_RELEASE_CHANNEL=stable PREFIX="$ZED_INSTALL_DIR" sh
#         ln -sf "$ZED_INSTALL_DIR/bin/zed" "$BIN_DIR/zed"
#     fi
# fi

 # 9.2 OPENCODE.AI
 if [ ! -d "$APPS_DIR/opencode" ]; then
     echo "  ðŸ¤– Installing OpenCode.ai (Local installation)..."
     mkdir -p "$APPS_DIR/opencode"
     # Run the official installer within the apps directory to keep it portable
     (cd "$APPS_DIR" && curl -fsSL https://opencode.ai/install | bash)
     # Create symlinks in your personal bin directory
     # 'code' is linked to opencode here to use it as your primary AI-powered editor
     ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/opencode"
     ln -sf "$APPS_DIR/opencode/bin/opencode" "$BIN_DIR/code"
     echo "  âœ… OpenCode.ai installed"
 fi
 
 # 9.2.1 BUN (for oh-my-opencode)
 if ! command -v bun &>/dev/null; then
    echo "  ðŸž Installing Bun..."
    # Custom installation directory to keep it contained in apps
    export BUN_INSTALL="$APPS_DIR/bun"
    curl -fsSL https://bun.sh/install | bash
    # Link binaries
    ln -sf "$BUN_INSTALL/bin/bun" "$BIN_DIR/bun"
    ln -sf "$BUN_INSTALL/bin/bunx" "$BIN_DIR/bunx"
 fi

 # 9.2.2 OH-MY-OPENCODE (Plugin)
 if command -v opencode &>/dev/null; then
     if ! opencode --version 2>&1 | grep -q "oh-my-opencode"; then
         echo "  âœ¨ Installing Oh My OpenCode..."
         # Assuming user wants standard setup without TUI to avoid hangs
         # Defaulting to GitHub Copilot support as seen in user's current setup
         # We'll use npx/bunx to run the installer non-interactively
         if command -v bunx &>/dev/null; then
             bunx oh-my-opencode install --no-tui --claude=no --openai=no --gemini=no --copilot=yes
         elif command -v npx &>/dev/null; then
             npx oh-my-opencode install --no-tui --claude=no --openai=no --gemini=no --copilot=yes
         else
             echo "  âš ï¸  bunx/npx not found. Please install Bun or Node.js to install oh-my-opencode."
         fi
     else
         echo "  âœ… Oh My OpenCode is already installed."
     fi
 fi

# 9.3 Yazi File Manager
echo "ðŸ“‚ Checking Yazi..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    if command -v brew &>/dev/null && ! command -v yazi &>/dev/null; then
        brew install yazi
    fi
else
    # Manual installation for Linux/42
    if [ ! -f "$BIN_DIR/yazi" ]; then
        echo "  ðŸ“¦ Installing Yazi..."
        YAZI_VER=$(curl -sI "https://github.com/sxyazi/yazi/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
        curl -L -o /tmp/yazi.zip "https://github.com/sxyazi/yazi/releases/download/${YAZI_VER}/yazi-x86_64-unknown-linux-musl.zip"
        unzip -q -o /tmp/yazi.zip -d /tmp
        YAZI_DIR=$(find /tmp -maxdepth 1 -type d -name "yazi-*-linux-musl" | head -n 1)
        if [ -d "$YAZI_DIR" ]; then
            mv "$YAZI_DIR/yazi" "$BIN_DIR/"
            [ -f "$YAZI_DIR/ya" ] && mv "$YAZI_DIR/ya" "$BIN_DIR/"
            rm -rf "$YAZI_DIR" /tmp/yazi.zip
        fi
    fi
fi

# --- 10. FINALIZATION ---
if [[ "$SHELL" != */zsh ]]; then
    echo "ðŸš Setting default shell to Zsh..."
    chsh -s $(which zsh)
fi

# --- 11. TERMINFO FALLBACKS ---
echo "ðŸ–¥ï¸  Setting up terminfo fallbacks..."
mkdir -p "$HOME/.terminfo"
if ! tput -T xterm-kitty colors &>/dev/null; then
    echo "  ðŸ± Adding xterm-kitty fallback..."
    infocmp xterm-256color | sed 's/xterm-256color/xterm-kitty/' | tic -o "$HOME/.terminfo" -
fi
if ! tput -T zellij colors &>/dev/null; then
    echo "  ðŸªŸ Adding zellij fallback..."
    infocmp xterm-256color | sed 's/xterm-256color/zellij/' | tic -o "$HOME/.terminfo" -
fi

echo "-------------------------------------------------------"
echo "âœ… Deployment Successful!"
echo "âœ¨ Restart your terminal or run 'source ~/.zshrc'"
echo "-------------------------------------------------------"

