#!/bin/bash

# 1. Dossiers de base
NK_DIR="$HOME/.nkermani"
APPS_DIR="$NK_DIR/apps"
BIN_DIR="$NK_DIR/bin"
NVIM_DIR="$APPS_DIR/nvim-nightly"

mkdir -p "$NK_DIR/apps" "$NK_DIR/bin"

# 2. Oh My Zsh
ZSH_DIR="$NK_DIR/apps/ohmyzsh"
if [ ! -d "$ZSH_DIR" ]; then
echo "üöÄ Installation de Oh My Zsh..."
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
# On le d√©place car le script OMZ est t√™tu
mv ~/.oh-my-zsh "$ZSH_DIR" 2>/dev/null || true
fi

# 3. Plugins
ZSH_CUSTOM="$ZSH_DIR/custom"
declare -A plugins=(
		["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting.git"
		["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
		["auto-notify"]="https://github.com/MichaelAquilina/zsh-auto-notify.git"
		["you-should-use"]="https://github.com/MichaelAquilina/zsh-you-should-use.git"
		["zsh-history-substring-search"]="https://github.com/zsh-users/zsh-history-substring-search"
		)

for name in "${!plugins[@]}"; do
if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
echo "üîå Installation du plugin $name..."
git clone "${plugins[$name]}" "$ZSH_CUSTOM/plugins/$name"
fi
done

# 4. Shell par d√©faut
if [[ "$SHELL" != */zsh ]]; then
	echo "üêö Changement du shell vers ZSH..."
chsh -s $(which zsh)
	fi




# --- DETECTION DE L'ENVIRONNEMENT (BASH) ---
	IS_WSL=$(grep -i "microsoft" /proc/version 2>/dev/null)
OS_TYPE=$(uname -s)

# --- LOGIQUE VS CODE ---
	if [[ "$OS_TYPE" == "Linux" ]]; then
	if [[ -z "$IS_WSL" ]]; then
# On est sur un Linux NATIF
	if [ ! -d "$APPS_DIR/vscode" ]; then
	echo "üì¶ Installation de VS Code (Linux x64)..."
	curl -L "https://code.visualstudio.com/sha/download?build=stable&os=linux-x64" -o vscode.tar.gz
	mkdir -p "$APPS_DIR/vscode"
	tar -xzf vscode.tar.gz -C "$APPS_DIR/vscode" --strip-components=1
	rm vscode.tar.gz
	ln -sf "$APPS_DIR/vscode/bin/code" "$BIN_DIR/code"
	fi
	else
	echo "‚ùÑÔ∏è WSL2 d√©tect√© : Utilisation de VS Code Windows (Remote WSL)."
	fi
	elif [[ "$OS_TYPE" == "Darwin" ]]; then
# On est sur macOS
	if ! command -v code &> /dev/null; then
	echo "üì¶ Installation de VS Code via Brew..."
	brew install --cask visual-studio-code
	fi
	fi

# --- LOGIQUE NEOVIM (Utilise le bool√©en de chezmoi.toml) ---



# --- LOGIQUE NEOVIM ---
{{ if .has_sudo -}}
echo "üîê Droits sudo confirm√©s dans chezmoi.toml"
NVIM_DIR="$HOME/.nkermani/apps/nvim-nightly"
BIN_DIR="$HOME/.nkermani/bin"

if [ ! -d "$NVIM_DIR" ]; then
    echo "üåô Installation de Neovim Nightly..."
    mkdir -p "$NVIM_DIR"
    curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz -o /tmp/nvim.tar.gz
    tar -xzf /tmp/nvim.tar.gz -C "$NVIM_DIR" --strip-components=1
    rm /tmp/nvim.tar.gz
    ln -sf "$NVIM_DIR/bin/nvim" "$BIN_DIR/nvim"
    echo "‚úÖ Neovim Nightly install√©."
fi
{{- else -}}
echo "‚ö†Ô∏è Sudo non autoris√© dans chezmoi.toml : Neovim ne sera pas install√©/mis √† jour."
{{- end }}

# Force update Sun Jan 11 11:10:41 AM CET 2026
