#!/bin/bash

# 1. Dossiers de base
NK_DIR="$HOME/.nkermani"
APPS_DIR="$NK_DIR/apps"
BIN_DIR="$NK_DIR/bin"
NVIM_DIR="$APPS_DIR/nvim-nightly"

mkdir -p "$NK_DIR/apps" "$NK_DIR/bin"

# 2. Oh My Zsh
ZSH_DIR="$NK_DIR/apps/ohmyzsh"
if [ ! -d "$ZSH_DIR" ]; then
echo "üöÄ Installation de Oh My Zsh..."
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
# On le d√©place car le script OMZ est t√™tu
mv ~/.oh-my-zsh "$ZSH_DIR" 2>/dev/null || true
fi

# 3. Plugins
ZSH_CUSTOM="$ZSH_DIR/custom"
declare -A plugins=(
		["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting.git"
		["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
		["auto-notify"]="https://github.com/MichaelAquilina/zsh-auto-notify.git"
		["you-should-use"]="https://github.com/MichaelAquilina/zsh-you-should-use.git"
		["zsh-history-substring-search"]="https://github.com/zsh-users/zsh-history-substring-search"
		)

for name in "${!plugins[@]}"; do
if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
echo "üîå Installation du plugin $name..."
git clone "${plugins[$name]}" "$ZSH_CUSTOM/plugins/$name"
fi
done

# 4. Shell par d√©faut
if [[ "$SHELL" != */zsh ]]; then
	echo "üêö Changement du shell vers ZSH..."
chsh -s $(which zsh)
	fi

# --- 5. OUTILS CLI (ripgrep, fzf, fd) - SUDOLESS ---
echo "üõ†Ô∏è V√©rification des outils CLI..."

# FZF
if [ ! -f "$BIN_DIR/fzf" ]; then
    echo "üîç Installation de fzf..."
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --bin
    cp ~/.fzf/bin/fzf "$BIN_DIR/"
fi

# Ripgrep (rg)
if ! command -v rg &> /dev/null; then
    echo "üìÇ Installation de ripgrep..."
    RG_VERSION=$(curl -sI https://github.com/BurntSushi/ripgrep/releases/latest | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
    curl -LSs "https://github.com/BurntSushi/ripgrep/releases/download/${RG_VERSION}/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/rg.tar.gz
    tar -xzf /tmp/rg.tar.gz -C /tmp
    cp /tmp/ripgrep-${RG_VERSION}-x86_64-unknown-linux-musl/rg "$BIN_DIR/"
fi

# FD
if ! command -v fd &> /dev/null; then
    echo "‚ö° Installation de fd..."
    FD_VERSION=$(curl -sI https://github.com/sharkdp/fd/releases/latest | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
    curl -LSs "https://github.com/sharkdp/fd/releases/download/${FD_VERSION}/fd-${FD_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/fd.tar.gz
    tar -xzf /tmp/fd.tar.gz -C /tmp
    cp /tmp/fd-${FD_VERSION}-x86_64-unknown-linux-musl/fd "$BIN_DIR/"
fi

# Bat (cat with wings)
if ! command -v bat &> /dev/null; then
    echo "ü¶á Installation de bat..."
    # R√©cup√©ration de la derni√®re version via l'API GitHub
    BAT_VERSION=$(curl -sI https://github.com/sharkdp/bat/releases/latest | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')

    # T√©l√©chargement de l'archive pour Linux (architecture x86_64 avec musl pour la portabilit√© √† 42)
    curl -LSs "https://github.com/sharkdp/bat/releases/download/${BAT_VERSION}/bat-${BAT_VERSION}-x86_64-unknown-linux-musl.tar.gz" -o /tmp/bat.tar.gz

    # Extraction et d√©placement du binaire
    tar -xzf /tmp/bat.tar.gz -C /tmp
    cp /tmp/bat-${BAT_VERSION}-x86_64-unknown-linux-musl/bat "$BIN_DIR/"

    # Note : √Ä 42, certains alias peuvent entrer en conflit.
    # Si 'bat' n'affiche rien, v√©rifie ton PATH ou utilise 'batcat' si tu pr√©f√®res l'alias Debian.
    echo "‚úÖ bat install√© dans $BIN_DIR"
fi


# --- DETECTION DE L'ENVIRONNEMENT (BASH) ---
	IS_WSL=$(grep -i "microsoft" /proc/version 2>/dev/null)
OS_TYPE=$(uname -s)

# --- LOGIQUE VS CODE ---
	if [[ "$OS_TYPE" == "Linux" ]]; then
	if [[ -z "$IS_WSL" ]]; then
# On est sur un Linux NATIF
	if [ ! -d "$APPS_DIR/vscode" ]; then
	echo "üì¶ Installation de VS Code (Linux x64)..."
	curl -L "https://code.visualstudio.com/sha/download?build=stable&os=linux-x64" -o vscode.tar.gz
	mkdir -p "$APPS_DIR/vscode"
	tar -xzf vscode.tar.gz -C "$APPS_DIR/vscode" --strip-components=1
	rm vscode.tar.gz
	ln -sf "$APPS_DIR/vscode/bin/code" "$BIN_DIR/code"
	fi
	else
	echo "‚ùÑÔ∏è WSL2 d√©tect√© : Utilisation de VS Code Windows (Remote WSL)."
	fi
	elif [[ "$OS_TYPE" == "Darwin" ]]; then
# On est sur macOS
	if ! command -v code &> /dev/null; then
	echo "üì¶ Installation de VS Code via Brew..."
	brew install --cask visual-studio-code
	fi
	fi


# --- LOGIQUE KITTY (42 & Linux Natif) ---
if [[ "$OS_TYPE" == "Linux" && -z "$IS_WSL" ]]; then
    if [ ! -d "$APPS_DIR/kitty.app" ]; then
        echo "üê± Installation de Kitty Terminal (Linux x64)..."

        # 1. T√©l√©chargement et installation via le script officiel
        # On d√©finit 'dest' mais on retire 'launch_prefix' qui pose probl√®me
        curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin \
            dest="$APPS_DIR"

        # 2. Cr√©ation manuelle du lien symbolique dans ton BIN_DIR
        ln -sf "$APPS_DIR/kitty.app/bin/kitty" "$BIN_DIR/kitty"

        # 3. Int√©gration Desktop (si le dossier existe)
        if [ -d "$APPS_DIR/kitty.app/share/applications" ]; then
            mkdir -p ~/.local/share/applications
            cp "$APPS_DIR/kitty.app/share/applications/kitty.desktop" ~/.local/share/applications/

            # Correction des chemins dans le fichier .desktop
            sed -i "s|Icon=kitty|Icon=$APPS_DIR/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" ~/.local/share/applications/kitty.desktop
            # On utilise le chemin complet vers l'ex√©cutable
            sed -i "s|Exec=kitty|Exec=$APPS_DIR/kitty.app/bin/kitty|g" ~/.local/share/applications/kitty.desktop

            echo "‚úÖ Kitty install√© et raccourci bureau cr√©√©."
        fi
    fi
fi

# --- LOGIQUE NEOVIM (Utilise le bool√©en de chezmoi.toml) ---
{{ if .has_sudo -}}
echo "üîê Droits sudo confirm√©s dans chezmoi.toml"
NVIM_DIR="$HOME/.nkermani/apps/nvim-nightly"
BIN_DIR="$HOME/.nkermani/bin"

if [ ! -d "$NVIM_DIR" ]; then
    echo "üåô Installation de Neovim Nightly..."
    mkdir -p "$NVIM_DIR"
    curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz -o /tmp/nvim.tar.gz
    tar -xzf /tmp/nvim.tar.gz -C "$NVIM_DIR" --strip-components=1
    rm /tmp/nvim.tar.gz
    ln -sf "$NVIM_DIR/bin/nvim" "$BIN_DIR/nvim"
    echo "‚úÖ Neovim Nightly install√©."

	# 2. Installation de Rust (uniquement si absent et utile pour Neovim/Mason)
    if ! command -v cargo &> /dev/null; then
        echo "ü¶Ä Rust non trouv√©, installation pour les besoins de Neovim..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
    fi
fi
{{- else -}}
echo "‚ö†Ô∏è Sudo non autoris√© dans chezmoi.toml : Neovim ne sera pas install√©/mis √† jour."
{{- end }}

# Force update Sun Jan 11 11:10:41 AM CET 2026
