#!/bin/bash

# --- CONFIGURATION CHEZMOI ---
# .is_42 : {{ .is_42 }}
# .has_sudo : {{ .has_sudo }}

# 1. Dossiers de base
NK_DIR="$HOME/.nkermani"
APPS_DIR="$NK_DIR/apps"
BIN_DIR="$NK_DIR/bin"
mkdir -p "$APPS_DIR" "$BIN_DIR"

# D√©tection imm√©diate de l'OS et environnement (Important pour la suite)
OS_TYPE=$(uname -s)
IS_WSL=$(grep -i "microsoft" /proc/version 2>/dev/null)

# 2. Oh My Zsh & Plugins (Tous tes plugins sont ici)
ZSH_DIR="$APPS_DIR/ohmyzsh"
if [ ! -d "$ZSH_DIR" ]; then
    echo "üöÄ Installation de Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended --keep-zshrc
    mv ~/.oh-my-zsh "$ZSH_DIR" 2>/dev/null || true
fi

ZSH_CUSTOM="$ZSH_DIR/custom"
declare -A plugins=(
    ["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting.git"
    ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
    ["auto-notify"]="https://github.com/MichaelAquilina/zsh-auto-notify.git"
    ["you-should-use"]="https://github.com/MichaelAquilina/zsh-you-should-use.git"
    ["zsh-history-substring-search"]="https://github.com/zsh-users/zsh-history-substring-search"
)

for name in "${!plugins[@]}"; do
    if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
        echo "üîå Installation du plugin $name..."
        git clone "${plugins[$name]}" "$ZSH_CUSTOM/plugins/$name"
    fi
done

# 3. OUTILS CLI (Sudo-less - Ripgrep, FZF, FD, Bat)
echo "üõ†Ô∏è Installation des outils CLI..."

if [[ "$OS_TYPE" == "Darwin" ]]; then
    if command -v brew &>/dev/null; then
        brew install fzf ripgrep fd bat
    fi
else
    # FZF
    [ ! -f "$BIN_DIR/fzf" ] && git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --bin && cp ~/.fzf/bin/fzf "$BIN_DIR/"

    # Binaires Musl (Optimis√© avec une boucle pour Ripgrep, FD, Bat)
    for tool in "ripgrep:rg:BurntSushi/ripgrep" "fd:fd:sharkdp/fd" "bat:bat:sharkdp/bat"; do
        IFS=":" read -r name bin repo <<< "$tool"
        if ! command -v "$bin" &>/dev/null; then
            echo "üì¶ Installation de $name..."
            VER=$(curl -sI "https://github.com/$repo/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
            curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${VER}-x86_64-unknown-linux-musl.tar.gz" | tar -xzC /tmp
            cp /tmp/${name}-${VER}-x86_64-unknown-linux-musl/"$bin" "$BIN_DIR/"
        fi
    done
fi

# --- 4. POLICES (JetBrains Mono Nerd Font) ---
if [[ "$OS_TYPE" == "Linux" ]]; then
    FONT_DIR="$HOME/.local/share/fonts"
    # On v√©rifie si le dossier existe d√©j√† OU si la font est d√©j√† install√©e dans le syst√®me
    if [ ! -d "$FONT_DIR/JetBrainsMono" ] && ! fc-list | grep -qi "JetBrainsMono"; then
        echo "üíæ JetBrainsMono Nerd Font non trouv√©e. Installation..."
        mkdir -p "$FONT_DIR/JetBrainsMono"

        # T√©l√©chargement dans /tmp pour √©conomiser le quota disque
        curl -L -o /tmp/jb.zip https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/JetBrainsMono.zip

        # -o pour overwrite sans demander, -d pour la destination
        unzip -o /tmp/jb.zip -d "$FONT_DIR/JetBrainsMono"

        # Nettoyage imm√©diat du zip
        rm /tmp/jb.zip

        # Mise √† jour du cache des polices (le -f force la relecture)
        echo "Updating font cache..."
        fc-cache -f
        echo "‚úÖ Police install√©e avec succ√®s."
    else
        echo "‚úÖ JetBrainsMono Nerd Font est d√©j√† pr√©sente."
    fi
fi

# 5. LOGIQUE SPECIFIQUE (42 vs PERSO)
{{ if .is_42 -}}
echo "üè´ Mode 42 activ√©..."
if [[ "$OS_TYPE" == "Linux" && -z "$IS_WSL" ]]; then
    # VS Code
    if [ ! -d "$APPS_DIR/vscode" ]; then
        echo "üì¶ Installation VS Code..."
        curl -L "https://code.visualstudio.com/sha/download?build=stable&os=linux-x64" | tar -xzC "$APPS_DIR"
        mv "$APPS_DIR/VSCode-linux-x64" "$APPS_DIR/vscode" 2>/dev/null
        ln -sf "$APPS_DIR/vscode/bin/code" "$BIN_DIR/code"
    fi
    # Kitty + Ic√¥nes Desktop
    if [ ! -d "$APPS_DIR/kitty.app" ]; then
        echo "üê± Installation Kitty..."
        curl -L https://sw.kovidgoyal.net/kitty/installer.sh | sh /dev/stdin dest="$APPS_DIR"
        ln -sf "$APPS_DIR/kitty.app/bin/kitty" "$BIN_DIR/kitty"
        mkdir -p ~/.local/share/applications
        cp "$APPS_DIR/kitty.app/share/applications/kitty.desktop" ~/.local/share/applications/
        sed -i "s|Icon=kitty|Icon=$APPS_DIR/kitty.app/share/icons/hicolor/256x256/apps/kitty.png|g" ~/.local/share/applications/kitty.desktop
        sed -i "s|Exec=kitty|Exec=$APPS_DIR/kitty.app/bin/kitty|g" ~/.local/share/applications/kitty.desktop
    fi
fi
{{- end }}

# 6. NEOVIM (Bas√© sur Sudo)
{{ if .has_sudo -}}
if ! command -v nvim &>/dev/null; then
    echo "üåô Installation Neovim Nightly..."
    NVIM_DIR="$APPS_DIR/nvim-nightly"
    mkdir -p "$NVIM_DIR"
    curl -LSs https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz | tar -xzC "$NVIM_DIR" --strip-components=1
    ln -sf "$NVIM_DIR/bin/nvim" "$BIN_DIR/nvim"

    if ! command -v cargo &>/dev/null; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
    fi
fi
{{- end }}

# 7. Shell par d√©faut
if [[ "$SHELL" != */zsh ]]; then
    echo "üêö Changement du shell vers ZSH..."
    chsh -s $(which zsh)
fi

echo "‚ú® Termin√© ! Relance ton terminal ou 'source ~/.zshrc'."
