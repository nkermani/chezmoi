#!/bin/bash
{{ include ".chezmoitemplates/env.sh.tmpl" }}

echo "ðŸ› ï¸  Installing CLI utilities..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    # Homebrew handles architecture automatically on macOS
    if command -v brew &>/dev/null; then
        brew install fzf ripgrep fd bat cmake tmux
    fi
else
    # Manual installation for Linux/42 (Portable Binaries)
    [ ! -f "$BIN_DIR/fzf" ] && {
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --bin && cp ~/.fzf/bin/fzf "$BIN_DIR/" && rm -rf ~/.fzf
    }

    # Architecture detection for Linux binaries
    LINUX_ARCH="x86_64"
    [[ "$ARCH_TYPE" == "aarch64" ]] && LINUX_ARCH="aarch64"

    for tool in "ripgrep:rg:BurntSushi/ripgrep" "fd:fd:sharkdp/fd" "bat:bat:sharkdp/bat"; do
        IFS=":" read -r name bin repo <<< "$tool"
        if [ ! -f "$BIN_DIR/$bin" ]; then
            echo "  ðŸ“¦ Fetching $name..."
            VER=$(curl -sI "https://github.com/$repo/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
            curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${VER}-${LINUX_ARCH}-unknown-linux-musl.tar.gz" | tar -xzC /tmp
            find /tmp/${name}-${VER}-${LINUX_ARCH}-unknown-linux-musl -name "$bin" -type f -exec cp {} "$BIN_DIR/" \;
        fi
    done

    # CMake installation for Linux/42 (Portable Binary)
    if [ ! -f "$BIN_DIR/cmake" ]; then
        echo "  ðŸ“¦ Fetching CMake..."
        CMAKE_VER="3.31.5"
        curl -LSs "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VER}/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}.tar.gz" | tar -xzC "$APPS_DIR"
        ln -sf "$APPS_DIR/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}/bin/cmake" "$BIN_DIR/cmake"
        ln -sf "$APPS_DIR/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}/bin/ctest" "$BIN_DIR/ctest"
    fi

    # Tmux installation for Linux/42 (Static Binary)
    if [ ! -f "$BIN_DIR/tmux" ] || head -n 1 "$BIN_DIR/tmux" 2>/dev/null | grep -q "Not Found"; then
        echo "  ðŸ“¦ Fetching Tmux (Static)..."
        TMUX_VER="3.6a"
        TMUX_ARCH="x86_64"
        [[ "$ARCH_TYPE" == "aarch64" || "$ARCH_TYPE" == "arm64" ]] && TMUX_ARCH="arm64"
        curl -LSs "https://github.com/tmux/tmux-builds/releases/download/v${TMUX_VER}/tmux-${TMUX_VER}-linux-${TMUX_ARCH}.tar.gz" | tar -xzC "$BIN_DIR"
        chmod +x "$BIN_DIR/tmux"
    fi
fi
