#!/bin/bash
{{ include ".chezmoitemplates/env.sh.tmpl" }}

echo "ðŸ› ï¸  Installing CLI utilities..."
if [[ "$OS_TYPE" == "Darwin" ]]; then
    # Homebrew handles architecture automatically on macOS
    if command -v brew &>/dev/null; then
        brew install fzf ripgrep fd bat cmake tmux lazygit starship zoxide clang-format zellij zig
    fi
else
    # Manual installation for Linux/42 (Portable Binaries)
    [ ! -f "$BIN_DIR/fzf" ] && {
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf && ~/.fzf/install --bin && cp ~/.fzf/bin/fzf "$BIN_DIR/" && rm -rf ~/.fzf
    }

    # Architecture detection for Linux binaries
    LINUX_ARCH="x86_64"
    [[ "$ARCH_TYPE" == "aarch64" ]] && LINUX_ARCH="aarch64"

    for tool in "ripgrep:rg:BurntSushi/ripgrep" "fd:fd:sharkdp/fd" "bat:bat:sharkdp/bat" "lazygit:lazygit:jesseduffield/lazygit" "zellij:zellij:zellij-org/zellij"; do
        IFS=":" read -r name bin repo <<< "$tool"
        if [ ! -f "$BIN_DIR/$bin" ]; then
            echo "  ðŸ“¦ Fetching $name..."
            VER=$(curl -sI "https://github.com/$repo/releases/latest" | grep -i "location:" | awk -F "/" '{print $NF}' | tr -d '\r')
            
            if [[ "$name" == "lazygit" ]]; then
                # LazyGit has a slightly different naming convention
                LG_ARCH="x86_64"
                [[ "$ARCH_TYPE" == "aarch64" ]] && LG_ARCH="arm64"
                curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}_${VER#v}_Linux_${LG_ARCH}.tar.gz" | tar -xzC /tmp
                cp /tmp/lazygit "$BIN_DIR/"
            elif [[ "$name" == "zellij" ]]; then
                # Zellij has a different naming convention (no version in filename)
                ZJ_ARCH="x86_64"
                [[ "$ARCH_TYPE" == "aarch64" || "$ARCH_TYPE" == "arm64" ]] && ZJ_ARCH="aarch64"
                curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${ZJ_ARCH}-unknown-linux-musl.tar.gz" -o /tmp/zellij.tar.gz
                tar -xzf /tmp/zellij.tar.gz -C /tmp
                rm /tmp/zellij.tar.gz
                cp /tmp/zellij "$BIN_DIR/"
                rm -rf /tmp/zellij
            else
                curl -LSs "https://github.com/$repo/releases/download/${VER}/${name}-${VER}-${LINUX_ARCH}-unknown-linux-musl.tar.gz" | tar -xzC /tmp
                find /tmp/${name}-${VER}-${LINUX_ARCH}-unknown-linux-musl -name "$bin" -type f -exec cp {} "$BIN_DIR/" \;
            fi
        fi
    done

    # Starship installation
    if [ ! -f "$BIN_DIR/starship" ]; then
        echo "  ðŸ“¦ Fetching Starship..."
        curl -sS https://starship.rs/install.sh | sh -s -- --yes --bin-dir "$BIN_DIR"
    fi

    # Zoxide installation
    if [ ! -f "$BIN_DIR/zoxide" ]; then
        echo "  ðŸ“¦ Fetching Zoxide..."
        curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | sh -s -- --bin-dir "$BIN_DIR"
    fi

    # CMake installation for Linux/42 (Portable Binary)
    if [ ! -f "$BIN_DIR/cmake" ]; then
        echo "  ðŸ“¦ Fetching CMake..."
        CMAKE_VER="3.31.5"
        curl -LSs "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VER}/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}.tar.gz" | tar -xzC "$APPS_DIR"
        ln -sf "$APPS_DIR/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}/bin/cmake" "$BIN_DIR/cmake"
        ln -sf "$APPS_DIR/cmake-${CMAKE_VER}-linux-${LINUX_ARCH}/bin/ctest" "$BIN_DIR/ctest"
    fi

    # Tmux installation for Linux/42 (Static Binary)
    if [ ! -f "$BIN_DIR/tmux" ] || head -n 1 "$BIN_DIR/tmux" 2>/dev/null | grep -q "Not Found"; then
        echo "  ðŸ“¦ Fetching Tmux (Static)..."
        TMUX_VER="3.6a"
        TMUX_ARCH="x86_64"
        [[ "$ARCH_TYPE" == "aarch64" || "$ARCH_TYPE" == "arm64" ]] && TMUX_ARCH="arm64"
        curl -LSs "https://github.com/tmux/tmux-builds/releases/download/v${TMUX_VER}/tmux-${TMUX_VER}-linux-${TMUX_ARCH}.tar.gz" | tar -xzC "$BIN_DIR"
        chmod +x "$BIN_DIR/tmux"
    fi

    # Zig installation (Portable Binary)
    if [ ! -f "$BIN_DIR/zig" ]; then
        echo "  ðŸ“¦ Fetching Zig..."
        ZIG_VER="0.15.2"
        ZIG_ARCH="x86_64"
        [[ "$ARCH_TYPE" == "aarch64" ]] && ZIG_ARCH="aarch64"
        curl -LSs "https://ziglang.org/download/${ZIG_VER}/zig-${ZIG_ARCH}-linux-${ZIG_VER}.tar.xz" | tar -xJ -C "$APPS_DIR"
        ln -sf "$APPS_DIR/zig-${ZIG_ARCH}-linux-${ZIG_VER}/zig" "$BIN_DIR/zig"
        ln -sf "$APPS_DIR/zig-${ZIG_ARCH}-linux-${ZIG_VER}/lib" "$APPS_DIR/zig-${ZIG_ARCH}-linux-${ZIG_VER}/lib64" 2>/dev/null || true
    fi
fi

